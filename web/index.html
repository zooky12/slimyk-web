<body>
  <div style="font-family:system-ui;padding:8px">
  <textarea id="levelJson" rows="6" style="width:100%"></textarea><br>
  <button id="load">Load</button>
  <button id="n">N</button><button id="e">E</button>
  <button id="s">S</button><button id="w">W</button>
  <pre id="state" style="max-height:200px;overflow:auto"></pre>
  <canvas id="grid" width="384" height="384" style="border:1px solid #999"></canvas>
</div>

<script type="module">
  import { initWasm } from './core/wasm-adapter.js';
  const base = new URL('./wasm/', import.meta.url).href;
  const api = await initWasm(base);
  let sid = null;

  const ta = document.querySelector('#levelJson');
  const pre = document.querySelector('#state');
  const cvs = document.querySelector('#grid');
  const ctx = cvs.getContext('2d');

  const toGridY = (sy) => (s.h - 1 - sy); 

  document.querySelector('#load').onclick = () => { sid = api.initLevel(ta.value);
const s0 = api.getState(sid);
console.log('INIT STATE:', s0);
draw(); };
  document.querySelector('#n').onclick = () => doMove(0);
  document.querySelector('#e').onclick = () => doMove(1);
  document.querySelector('#s').onclick = () => doMove(2);
  document.querySelector('#w').onclick = () => doMove(3);

  window.addEventListener('keydown', e => {
    if (!sid) return;
    const map = { ArrowUp:0, KeyW:0, ArrowRight:1, KeyD:1, ArrowDown:2, KeyS:2, ArrowLeft:3, KeyA:3 };
    if (e.code in map) { e.preventDefault(); doMove(map[e.code]); }
  });

  function doMove(d) {
    const r = api.step(sid, d);
    draw();
    if (r.win) alert('WIN!');
    if (r.lose) alert('LOSE!');
  }

  function draw() {
    const s = api.getState(sid);
    if (!s || !s.w || !s.h) return;

    const cell = Math.floor(Math.min(cvs.width / s.w, cvs.height / s.h));
    const toScreenY = (gy) => (s.h - 1 - gy); // <-- flip Y for rendering

    ctx.clearRect(0,0,cvs.width,cvs.height);

    // tiles
    for (let gy = 0; gy < s.h; gy++) {
      for (let gx = 0; gx < s.w; gx++) {
        const t = s.tiles[gy*s.w + gx] ?? 0;
        const sy = toScreenY(gy);
        ctx.fillStyle = t===1 ? '#333' : (t===2 ? '#58a' : t===3 ? '#7c7' : '#ddd');
        ctx.fillRect(gx*cell, sy*cell, cell-1, cell-1);
      }
    }

    // entities
    const ents = Array.isArray(s.entities) ? s.entities : [];
    ctx.fillStyle = '#c93';
    for (const e of ents) {
      const sy = toScreenY(e.y);
      ctx.fillRect(e.x*cell+2, sy*cell+2, cell-4, cell-4);
    }

    // player
    const p = s.player ?? { x:0, y:0 };
    const py = toScreenY(p.y);
    ctx.fillStyle = '#e22';
    ctx.fillRect(p.x*cell+3, py*cell+3, cell-6, cell-6);
  }
</script>

</body>
